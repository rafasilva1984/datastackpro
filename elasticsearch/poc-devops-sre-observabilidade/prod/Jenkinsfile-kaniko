pipeline {
  agent { label 'k8s-agent' }
  environment {
    REGISTRY_URL = 'docker.io'
    IMAGE_NAME   = 'CHANGEME/sampleapp'
    IMAGE_TAG    = "${env.BRANCH_NAME}-${env.BUILD_NUMBER}"
    CHART_DIR    = 'charts/sampleapp'
    KUBE_NS      = 'prod'
    REGISTRY_CREDS = 'docker-registry-creds'
  }
  stages {
    stage('Checkout') { steps { checkout scm } }
    stage('Unit') { steps { sh 'cd sampleapp && npm ci && npm test' } }
    stage('Build & Push (kaniko)') {
      steps {
        container('kaniko') {
          withCredentials([usernamePassword(credentialsId: "${REGISTRY_CREDS}", usernameVariable: 'USER', passwordVariable: 'PASS')]) {
            sh '''
              mkdir -p /kaniko/.docker
              echo "{"auths":{"$REGISTRY_URL":{"username":"$USER","password":"$PASS"}}}" > /kaniko/.docker/config.json
              /kaniko/executor --context `pwd` --dockerfile sampleapp/Dockerfile                 --destination $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG --destination $REGISTRY_URL/$IMAGE_NAME:latest
            '''
          }
        }
      }
    }
    stage('Deploy (Helm)') { steps { container('helm') { sh 'helm upgrade --install sampleapp $CHART_DIR -n $KUBE_NS --create-namespace --set image.repository=$REGISTRY_URL/$IMAGE_NAME --set image.tag=$IMAGE_TAG' } } }
  }
}
